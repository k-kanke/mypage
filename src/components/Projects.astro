---
const { items, labels } = Astro.props;

const toAssetPath = (path) => {
	if (!path) return path;
	if (/^(https?:)?\/\//.test(path)) return path;
	const base = import.meta.env.BASE_URL.endsWith('/')
		? import.meta.env.BASE_URL
		: `${import.meta.env.BASE_URL}/`;
	const normalized = path.startsWith('/') ? path.slice(1) : path;
	return `${base}${normalized}`;
};

const getGallery = (project) => {
	if (project.images?.length) return project.images.map(toAssetPath);
	if (project.image) return [toAssetPath(project.image)];
	return [];
};

const githubIcon = {
	viewBox: '0 0 24 24',
	path:
		'M12 2c-5.52 0-10 4.58-10 10.23 0 4.52 2.87 8.36 6.84 9.72.5.1.68-.22.68-.48 0-.24-.01-.86-.01-1.69-2.78.62-3.37-1.1-3.37-1.1-.45-1.2-1.11-1.52-1.11-1.52-.9-.64.07-.63.07-.63 1 .08 1.53 1.07 1.53 1.07.89 1.58 2.34 1.12 2.91.85.09-.66.35-1.12.63-1.38-2.22-.26-4.56-1.14-4.56-5.09 0-1.12.39-2.03 1.03-2.74-.1-.26-.45-1.32.1-2.75 0 0 .85-.28 2.78 1.05.81-.23 1.67-.35 2.53-.35.86 0 1.72.12 2.53.35 1.93-1.33 2.78-1.05 2.78-1.05.55 1.43.2 2.49.1 2.75.64.71 1.03 1.62 1.03 2.74 0 3.96-2.34 4.83-4.57 5.08.36.32.69.95.69 1.92 0 1.38-.01 2.49-.01 2.83 0 .27.18.6.69.48 3.96-1.36 6.83-5.2 6.83-9.72C22 6.58 17.52 2 12 2z',
};
---

<section class="card projects">
	<h2>{labels.title}</h2>
	<div class="grid">
		{items.map((project) => (
			<article class="project" data-project>
				<button
					class="project-open"
					type="button"
					aria-label={labels.openProjectAriaLabel(project.title)}
					data-open
				></button>
				{project.repoUrl ? (
					<a class="repo-link" href={project.repoUrl} aria-label={labels.repoAriaLabel}>
						<svg viewBox={githubIcon.viewBox} aria-hidden="true" focusable="false">
							<path d={githubIcon.path} />
						</svg>
					</a>
				) : null}
				{project.period ? <p class="project-period">{project.period}</p> : null}
				{project.image ? (
					<img
						class="project-image"
						src={toAssetPath(project.image)}
						alt={project.imageAlt ?? project.title}
					/>
				) : null}
				<div class="project-body">
					<h3>{project.title}</h3>
					{project.summary ? <p>{project.summary}</p> : project.Content ? <project.Content /> : null}
					{project.tags?.length ? (
						<div class="tag-list" role="list">
							{project.tags.map((tag) => (
								<span class="tag" role="listitem">{tag}</span>
							))}
						</div>
					) : null}
					{project.link ? (
						<a class="project-link" href={project.link}>
							{project.linkLabel ?? project.link}
						</a>
					) : null}
				</div>

				<dialog class="project-modal" data-modal>
					<div class="modal-content">
						<button class="modal-close" type="button" aria-label={labels.closeAriaLabel}>Ã—</button>
						<div class="modal-header">
							<h3>{project.title}</h3>
							{project.period ? <p class="project-period">{project.period}</p> : null}
						</div>
						{getGallery(project).length ? (
							<div class="modal-gallery" aria-label={labels.galleryAriaLabel}>
								{getGallery(project).map((src) => (
									<img class="modal-image" src={src} alt={project.title} />
								))}
							</div>
						) : null}
						<div class="modal-body">
							{project.Content ? <project.Content /> : project.summary ? <p>{project.summary}</p> : null}
							{project.tags?.length ? (
								<div class="tag-list" role="list">
									{project.tags.map((tag) => (
										<span class="tag" role="listitem">{tag}</span>
									))}
								</div>
							) : null}
							<div class="modal-links">
								{project.link ? <a href={project.link}>{project.linkLabel ?? project.link}</a> : null}
							</div>
						</div>
					</div>
				</dialog>
			</article>
		))}
	</div>
</section>

<script>
	const projects = document.querySelectorAll('[data-project]');
	projects.forEach((project) => {
		const dialog = project.querySelector('[data-modal]');
		const openBtn = project.querySelector('[data-open]');
		const closeBtn = project.querySelector('.modal-close');
		if (!dialog || !openBtn || !closeBtn) return;

		openBtn.addEventListener('click', () => dialog.showModal());
		closeBtn.addEventListener('click', (event) => {
			event.stopPropagation();
			dialog.close();
		});
		dialog.addEventListener('click', (event) => {
			if (event.target === dialog) dialog.close();
		});
		project.addEventListener('click', (event) => {
			if (event.target.closest('a')) return;
			if (event.target.closest('[data-open]')) return;
			if (event.target.closest('dialog')) return;
			if (event.target.closest('.modal-close')) return;
			dialog.showModal();
		});
	});
</script>

<style>
	.card {
		background: #ffffff;
		border-radius: 20px;
		padding: 28px 32px;
		border: 1px solid rgba(30, 30, 30, 0.06);
		box-shadow: 0 12px 30px rgba(30, 30, 30, 0.06);
	}

	.card h2 {
		margin: 0 0 16px;
		font-size: 16px;
		text-transform: uppercase;
		letter-spacing: 0.12em;
		color: #515151;
	}

	.grid {
		display: grid;
		grid-template-columns: repeat(2, minmax(0, 1fr));
		gap: 18px;
	}

	.project {
		padding: 16px 18px;
		border-radius: 16px;
		border: 1px solid rgba(30, 30, 30, 0.08);
		background: rgba(250, 250, 250, 0.9);
		display: grid;
		gap: 6px;
		position: relative;
	}

	.project-open {
		position: absolute;
		inset: 0;
		border: 0;
		background: transparent;
		cursor: pointer;
		z-index: 1;
		padding: 0;
		appearance: none;
		-webkit-appearance: none;
	}

	.repo-link {
		position: absolute;
		top: 12px;
		right: 12px;
		width: 26px;
		height: 26px;
		border-radius: 999px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		color: #1b4c4c;
		background: rgba(27, 76, 76, 0.1);
		transition: transform 0.15s ease, background 0.15s ease;
		z-index: 2;
	}

	.repo-link:hover {
		transform: translateY(-1px);
		background: rgba(27, 76, 76, 0.18);
	}

	.repo-link svg {
		width: 20px;
		height: 20px;
		fill: currentColor;
	}

	.project-period {
		margin: 0;
	}

	.project-image {
		width: 100%;
		aspect-ratio: 16 / 9;
		height: auto;
		object-fit: cover;
		border-radius: 12px;
		border: 1px solid rgba(30, 30, 30, 0.08);
		position: relative;
		z-index: 0;
	}

	.project-body {
		display: grid;
		gap: 6px;
	}

	.project-period {
		margin: 0;
		font-size: 11px;
		font-family: 'IBM Plex Mono', 'Noto Sans JP', monospace;
		letter-spacing: 0.08em;
		color: #6a6a6a;
		line-height: 1.2;
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
		min-height: 1.2em;
	}

	.project h3 {
		margin: 0 0 8px;
		font-size: 15px;
		font-family: 'IBM Plex Sans', 'Noto Sans JP', sans-serif;
		letter-spacing: 0.01em;
		font-weight: 400;
		color: #3f3f3f;
	}

	.project p {
		margin: 0 0 10px;
		font-size: 12px;
		line-height: 1.7;
		color: #3f3f3f;
	}

	.project :global(p) {
		margin: 0 0 10px;
		font-size: 12px;
		line-height: 1.7;
		color: #3f3f3f;
	}

	.project :global(ul) {
		margin: 0 0 10px;
		padding-left: 18px;
		display: grid;
		gap: 6px;
		font-size: 12px;
		line-height: 1.7;
		color: #3f3f3f;
	}

	.tag-list {
		margin: 0;
		display: flex;
		flex-wrap: wrap;
		gap: 6px;
	}

	.tag {
		font-size: 11px;
		font-family: 'IBM Plex Mono', 'Noto Sans JP', monospace;
		letter-spacing: 0.05em;
		padding: 3px 10px;
		border-radius: 999px;
		background: #ffffff;
		border: 1px solid rgba(40, 40, 40, 0.14);
		color: #4a4a4a;
	}

	.project-link {
		font-size: 12px;
		color: #1b4c4c;
		text-decoration: none;
		position: relative;
		z-index: 2;
	}

	.project-link:hover {
		text-decoration: underline;
	}

	.project-modal {
		border: none;
		padding: 0;
		width: min(720px, 92vw);
		border-radius: 20px;
		background: #ffffff;
		box-shadow: 0 30px 80px rgba(20, 20, 20, 0.2);
	}

	.project-modal::backdrop {
		background: rgba(16, 16, 16, 0.5);
	}

	.modal-content {
		position: relative;
		padding: 22px 24px 24px;
		display: grid;
		gap: 16px;
	}

	.modal-close {
		position: absolute;
		top: 12px;
		right: 12px;
		width: 28px;
		height: 28px;
		border-radius: 999px;
		border: none;
		background: rgba(27, 76, 76, 0.1);
		color: #1b4c4c;
		cursor: pointer;
		font-size: 18px;
	}

	.modal-header h3 {
		margin: 0 0 6px;
		font-size: 18px;
	}

	.modal-gallery {
		display: flex;
		align-items: center;
		gap: 12px;
		overflow-x: auto;
		scroll-snap-type: x proximity;
		padding: 0 4px 6px 0;
	}

	.modal-image {
		height: 360px;
		width: auto;
		max-width: 80vw;
		object-fit: contain;
		background: transparent;
		border-radius: 14px;
		border: 1px solid rgba(30, 30, 30, 0.08);
		scroll-snap-align: start;
	}

	.modal-gallery:has(.modal-image:only-child) {
		justify-content: center;
	}

	.modal-body {
		display: grid;
		gap: 10px;
	}

	.modal-links {
		display: flex;
		flex-wrap: wrap;
		gap: 12px;
	}

	.modal-links a {
		font-size: 12px;
		color: #1b4c4c;
		text-decoration: none;
	}

	.modal-links a:hover {
		text-decoration: underline;
	}

	@media (max-width: 640px) {
		.card {
			padding: 28px 24px;
		}

		.grid {
			grid-template-columns: 1fr;
		}
	}
</style>
