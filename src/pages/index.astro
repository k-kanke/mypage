---
import { getCollection, getEntryBySlug } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import Projects from '../components/Projects.astro';
import Articles from '../components/Articles.astro';
import Timeline from '../components/Timeline.astro';

const profileEntry = await getEntryBySlug('profile', 'index');
if (!profileEntry) {
	throw new Error('profile content not found');
}
const { Content: ProfileContent } = await profileEntry.render();
const profile = profileEntry.data;

const timelineEntries = await getCollection('timeline');
const sortedEntries = [...timelineEntries].sort((a, b) => b.slug.localeCompare(a.slug));
const timelineItems = await Promise.all(
	sortedEntries.map(async (entry) => {
		const { Content } = await entry.render();
		return {
			...entry.data,
			Content,
		};
	}),
);

const projectEntries = await getCollection('projects');
const sortedProjects = [...projectEntries].sort((a, b) => b.slug.localeCompare(a.slug));
const projects = await Promise.all(
	sortedProjects.map(async (entry) => {
		const { Content } = await entry.render();
		return {
			...entry.data,
			Content,
		};
	}),
);

const articleFiles = import.meta.glob('../content/articles/*.md');
let articles = [];

if (Object.keys(articleFiles).length > 0) {
	const articleEntries = await getCollection('articles', ({ data }) => !data.draft);
	const sortedArticles = [...articleEntries].sort(
		(a, b) => b.data.publishedAt.getTime() - a.data.publishedAt.getTime(),
	);
	articles = await Promise.all(
		sortedArticles.map(async (entry) => {
			const { Content } = await entry.render();
			return {
				...entry.data,
				Content,
			};
		}),
	);
}
---

<Layout>
	<main class="page">
		<Hero name={profile.name} role={profile.role} links={profile.links} Content={ProfileContent} />
		<Timeline items={timelineItems} />
		<Projects items={projects} />
		<Articles items={articles} />
	</main>
</Layout>

<style>
	.page {
		min-height: 100%;
		padding: 64px 20px 96px;
		max-width: 960px;
		margin: 0 auto;
		display: grid;
		gap: 40px;
	}

	@media (max-width: 640px) {
		.page {
			padding: 48px 16px 72px;
		}
	}
</style>
